# Music tools

A collection of self-written, personal tools to manage and enhance local music
listening experience. Emphasis on *personal* – these tools rely on numerous
conventions present on my filesystem and were never designed with the general
public in mind. The conventions are listed below. Use at your own risk.

## Features

1. `plfix`
    - Remove redundant duplicate lines from playlist/playcount files.
    - Detect invalid paths and offer to interactively fix them.
2. `plrare`
    - Keep track of how much time was spent listening to what music.
    - Print command-line summaries over a period of time.

## Conventions

I heavily rely on [beets](https://beets.io/) and
[MusicBrainz](https://musicbrainz.org/) for maintaining a directory structure
and tagging. Check my [beets configuration](https://github.com/Randoragon/dotfiles/blob/master/beets/.config/beets/config.yaml)
for more details.

### 1. Directory structure

Everything is stored in the top-level `~/Music` directory, following
`artist/album/title` subdirectory organization, e.g.:

- `~/Music/Queen/A Night at the Opera/Bohemian Rhapsody.mp3`
- `~/Music/Tom Petty and the Heartbreakers/Greatest Hits/Mary Jane’s Last Dance.mp3`
- `~/Music/Daft Punk/Random Access Memories/Touch feat. Paul Williams.mp3`

Single releases are grouped under a `no album` directory, e.g.:

- `~/Music/deadmau5/no album/Ghosts ’n’ Stuff (original instrumental mix).mp3`
- `~/Music/The Beatles/no album/Let It Be.mp3`
- `~/Music/Gerry Rafferty/no album/Baker Street.mp3`

In some cases (must notably OSTs), many artists contribute to a release.
Then, a `Various Artists` directory may be used, e.g.:

- `~/Music/Various Artists/Beverly Hills Cop/Axel F.mp3`
- `~/Music/Various Artists/Hotline Miami - Official Soundtrack/Musikk per automatikk.mp3`
- `~/Music/Various Artists/Yu-Gi-Oh! Music to Duel By/No Matter What.mp3`

When few artists are involved, it is also acceptable to include both names in
the directory name, e.g.:

- `~/Music/Kenet & Rez/no album/Unreal Super Hero 3.mp3`
- `~/Music/1f1n1ty, Stardew/Sky Wander/Plümmet.mp3`
- `~/Music/Cliff Richard with The Shadows and Norrie Paramor & His Orchestra/32 Minutes and 17 Seconds With Cliff Richard/Turn Around.mp3`

The last of the above examples is pushing it with length, but you get the point.

If an artist features on another artist's record, it is better to include that
in the filename, rather than the artist directory name, e.g.:

- `~/Music/Gorillaz/Demon Days/Feel Good Inc. feat. De La Soul.mp3`
- `~/Music/Jason Becker/Triumphant Hearts/Valley of Fire feat. Michael Lee Firkins, Steve Vai, Joe Bonamassa, Paul Gilbert, Neal Schon, Mattias IA Eklundh, Marty Friedman, Greg Howe, Jeff Loomis, Richie Kotzen, Gus G., Steve Hunter, Ben W.mp3`
- `~/Music/Pendulum/Hold Your Colour/Tarantula feat. DJ Fresh, Spyda & Tenor Fly.mp3`

Again, some extreme in length examples here. No system is perfect. Luckily, the
exact format of this does not matter. I don't even attempt to parse it in any of
my tools, precisely because of how unreliable and inconsistent it sometimes is.
The most important is the division into `artist/album/title`.

### 2. Tags

Every file is individually tagged using the ID3v2.4 standard
([mutagen](https://pypi.org/project/mutagen/)). The tags are the main source of
information about artist, album, etc. The directory structure is far too
unreliable for that purpose and mainly exists to keep things organized and
browsable without a music player.

### 3. Playlists

Playlists are stored in `~/Music/Playlists`. They are in the m3u format, i.e.
plain text, line-by-line, where each line is a file path relative to `~/Music`.

I use playlists very extensively for tagging-like purposes:

Filename prefix | Type | Examples
:---: | :---: | :---:
`_` | Broad categories | `_Instrumental.m3u`, `_Vocal.m3u`, `_Acoustic.m3u`, `_Electronic.m3u`
`@` | Genre | `@Breakbeat.m3u`, `@Classical.m3u`, `@Synthwave.m3u`, `@Prog Rock.m3u`
`%` | Time signature | `%3_4.m3u`, `%6_8.m3u`, `%Variable.m3u`
`#` | Misc Tags | `#Fast.m3u`, `#Pop Culture.m3u`, `#Dance.m3u`, `#Lo-Fi.m3u`
`!` | Mood | `!Calm.m3u`, `!Intense.m3u`, `!Happy.m3u`, `!Nostalgic.m3u`
`=` | Actual playlist | `=Favorites.m3u`, `=Karaoke.m3u`
`.` | Meta-playlist | `.Filtered.m3u` (playlists autogenerated by tools)
`hist.` | History (by hostname) | `hist.homebox.m3u`, `hist.phone.m3u`

The difference between "tags" (`#`) and "playlists" (`=`) is that tags describe
some characteristic of the music itself, whereas playlists can be completely
arbitrary.

Advantages of keeping playlists over embedding tags in actual files:

1. Simple to view and edit by hand.
2. Easier to sync with other devices – no need to redownload mp3 files.
3. Great for querying – merging text files is easy (e.g. "find tracks that
   combine alt-rock, electronic and that are calm, but without vocals").
4. Built-in support by most music players.
5. Playlists are easy to rename and guarantee integrity, e.g. no chance of
   "forsaken" playlists piling up in random files' tags.

Disadvantages:

1. If any file path changes, playlists need to be fixed.
2. Not as trivial to find all information about a given track (scan through all
   playlists needed).

### 4. History & playcount

My music player, [ncmpcpp](https://github.com/ncmpcpp/ncmpcpp), allows me to run
a [custom script](https://github.com/Randoragon/dotfiles/blob/master/scripts/.scripts/ncmpcpp-song-change.sh) on song change. I use this to keep a history of played tracks
and count how many each was played. The history is kept in `hist.*.m3u` playlists,
as listed in the previous section's table. The playcounts are stored per-month
inside a `~/Music/.playcount/` directory in a plain-text format, with each line
holding 6 tab-seperated values: `[duration, artist, album artist, album, title, path]`

```
~/Music/.playcount/2023-06.tsv:
274.2	Rage Against the Machine	Rage Against the Machine	Renegades	Renegades Of Funk	Rage Against the Machine/Renegades/Renegades Of Funk.mp3
428.56488	The Beatles	The Beatles	Hey Jude	Hey Jude	The Beatles/Hey Jude/Hey Jude.mp3
303.648	LCD Soundsystem	LCD Soundsystem	London Sessions	Daft Punk Is Playing at My House	LCD Soundsystem/London Sessions/Daft Punk Is Playing at My House.mp3
230.32164	Ap0c	Various Artists	Hikikomori	3am Tuesday	Various Artists/Hikikomori/3am Tuesday.mp3
...
```

Playcount files are incredibly useful for autogenerating statistics and reports
over longer listening periods. I wrote this system because I got jealous of
Spotify users sharing their monthly and annual summaries.
